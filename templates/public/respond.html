{% extends "base.html" %}

{% block title %}Respond to Request - {{ request.item_name }}{% endblock %}

{% block content %}
<div class="mb-3">
    <a href="/" class="btn btn-secondary">&larr; Back to All Requests</a>
</div>

<!-- Request Details -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Request Details</h4>
    </div>
    <div class="card-body">
        <h5>{{ request.item_name }}</h5>
        <p><strong>Quantity Needed:</strong> {{ request.quantity_needed }} {{ request.unit }}</p>

        {% if request.description %}
        <p><strong>Description:</strong> {{ request.description }}</p>
        {% endif %}

        <p class="text-muted mb-0">
            <small>Posted: {{ request.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
        </p>
    </div>
</div>

<!-- Response Form -->
<div class="card shadow-sm">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0">Submit Your Response</h4>
    </div>
    <div class="card-body">
        <form id="responseForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="quantityAvailable" class="form-label">
                        Quantity Available <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="quantityAvailable"
                               name="quantity_available" min="1" required
                               placeholder="How many {{ request.unit }} do you have?">
                        <span class="input-group-text">{{ request.unit }}</span>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="location" class="form-label">
                        Location <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" id="location"
                           name="location" required
                           placeholder="Where are you located?">
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="responderName" class="form-label">
                        Your Name <span class="text-muted">(optional)</span>
                    </label>
                    <input type="text" class="form-control" id="responderName"
                           name="responder_name"
                           placeholder="Enter your name">
                </div>

                <div class="col-md-6 mb-3">
                    <label for="responderContact" class="form-label">
                        Contact Information <span class="text-muted">(optional)</span>
                    </label>
                    <input type="text" class="form-control" id="responderContact"
                           name="responder_contact"
                           placeholder="Phone or email">
                </div>
            </div>

            <div class="mb-3">
                <label for="notes" class="form-label">
                    Additional Notes <span class="text-muted">(optional)</span>
                </label>
                <textarea class="form-control" id="notes" name="notes" rows="3"
                          placeholder="Any additional information (e.g., availability, delivery options)"></textarea>
            </div>

            <div id="successMessage" class="alert alert-success d-none" role="alert">
                <strong>Thank you!</strong> Your response has been submitted successfully.
            </div>

            <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>

            <button type="submit" class="btn btn-success btn-lg w-100" id="submitBtn">
                Submit Response
            </button>
        </form>

        <div class="text-center mt-3">
            <small class="text-muted">
                <span class="text-danger">*</span> Required fields
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('responseForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = document.getElementById('submitBtn');
    setButtonLoading(submitBtn, true, 'Submitting...');

    const formData = {
        quantity_available: parseInt(document.getElementById('quantityAvailable').value),
        location: document.getElementById('location').value,
        responder_name: document.getElementById('responderName').value || null,
        responder_contact: document.getElementById('responderContact').value || null,
        notes: document.getElementById('notes').value || null
    };

    try {
        await apiFetch('/api/public/requests/{{ request.id }}/responses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        showToast('Thank you! Your response has been submitted successfully.', 'success');
        document.getElementById('responseForm').reset();

        // Redirect after showing toast
        setTimeout(() => {
            window.location.href = '/';
        }, 2000);
    } catch (error) {
        showToast(error.message, 'error');
        setButtonLoading(submitBtn, false);
    }
});
</script>
{% endblock %}
