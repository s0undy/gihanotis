{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block nav_items %}
<li class="nav-item">
    <a class="nav-link" href="/">Public View</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="/admin">Dashboard</a>
</li>
<li class="nav-item">
    <button class="btn btn-link nav-link" id="logoutBtn">Logout</button>
</li>
{% endblock %}

{% block content %}
<h1 class="mb-4">Admin Dashboard</h1>

<!-- Create New Request Form -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">Create New Request</h5>
    </div>
    <div class="card-body">
        <form id="createRequestForm">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="itemName" class="form-label">Item Name</label>
                    <input type="text" class="form-control" id="itemName" name="item_name" required placeholder="e.g., Shovels">
                </div>

                <div class="col-md-3 mb-3">
                    <label for="quantity" class="form-label">Quantity Needed</label>
                    <input type="number" class="form-control" id="quantity" name="quantity_needed" min="1" required placeholder="e.g., 5">
                </div>

                <div class="col-md-2 mb-3">
                    <label for="unit" class="form-label">Unit</label>
                    <input type="text" class="form-control" id="unit" name="unit" required placeholder="e.g., pieces">
                </div>

                <div class="col-md-3 mb-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-success w-100">Create Request</button>
                </div>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description (optional)</label>
                <textarea class="form-control" id="description" name="description" rows="2" placeholder="Additional details about this request"></textarea>
            </div>
        </form>
    </div>
</div>

<!-- All Requests Table -->
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">All Requests</h5>
        <input type="text" id="searchBox" class="form-control form-control-sm" placeholder="Search requests..." style="max-width: 300px;">
    </div>
    <div class="card-body">
        {% if requests %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Item</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Status</th>
                        <th>Responses</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr class="request-row">
                        <td>{{ req.id }}</td>
                        <td><strong>{{ req.item_name }}</strong></td>
                        <td>
                            <div>{{ req.quantity_needed }} {{ req.unit }}</div>
                            {% if req.quantity_needed == 0 %}
                            <div class="progress mt-1" style="height: 5px;">
                                <div class="progress-bar bg-success" style="width: 100%"></div>
                            </div>
                            <small class="text-success">Fulfilled</small>
                            {% endif %}
                        </td>
                        <td>{{ req.unit }}</td>
                        <td>
                            {% if req.status == 'open' %}
                                <span class="badge bg-success">Open</span>
                            {% else %}
                                <span class="badge bg-secondary">Closed</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info">{{ req.response_count }} responses</span>
                        </td>
                        <td>{{ req.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <a href="/admin/request/{{ req.id }}" class="btn btn-sm btn-primary">View Details</a>
                            {% if req.status == 'open' %}
                            <button class="btn btn-sm btn-warning" onclick="closeRequest({{ req.id }})">Close</button>
                            {% endif %}
                            <button class="btn btn-sm btn-danger" onclick="deleteRequest({{ req.id }})">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No requests yet. Create your first request above.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Search functionality
document.getElementById('searchBox').addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.request-row');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Create new request
document.getElementById('createRequestForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    setButtonLoading(submitBtn, true, 'Creating...');

    const formData = {
        item_name: document.getElementById('itemName').value,
        quantity_needed: parseInt(document.getElementById('quantity').value),
        unit: document.getElementById('unit').value,
        description: document.getElementById('description').value
    };

    try {
        const data = await apiFetch('/api/requests', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        showToast('Request created successfully!', 'success');
        setTimeout(() => window.location.reload(), 1000);
    } catch (error) {
        showToast(error.message, 'error');
        setButtonLoading(submitBtn, false);
    }
});

// Close request
async function closeRequest(id) {
    if (!confirm('Are you sure you want to close this request?')) return;

    const btn = event.target;
    setButtonLoading(btn, true, 'Closing...');

    try {
        await apiFetch(`/api/requests/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'closed' })
        });

        showToast('Request closed successfully!', 'success');

        // Update the row directly instead of reloading
        const row = btn.closest('tr');
        const statusBadge = row.querySelector('td:nth-child(5) span');
        statusBadge.className = 'badge bg-secondary';
        statusBadge.textContent = 'Closed';
        btn.style.display = 'none';
    } catch (error) {
        showToast(error.message, 'error');
        setButtonLoading(btn, false);
    }
}

// Delete request
async function deleteRequest(id) {
    if (!confirm('Are you sure you want to delete this request? This action cannot be undone.')) return;

    const btn = event.target;
    setButtonLoading(btn, true, 'Deleting...');

    try {
        await apiFetch(`/api/requests/${id}`, {
            method: 'DELETE'
        });

        showToast('Request deleted successfully!', 'success');

        // Remove the row from the table
        const row = btn.closest('tr');
        row.style.transition = 'opacity 0.3s';
        row.style.opacity = '0';
        setTimeout(() => row.remove(), 300);
    } catch (error) {
        showToast(error.message, 'error');
        setButtonLoading(btn, false);
    }
}

// Logout
document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
        await apiFetch('/api/auth/logout', {
            method: 'POST'
        });

        showToast('Logged out successfully', 'success');
        setTimeout(() => window.location.href = '/admin/login', 500);
    } catch (error) {
        showToast(error.message, 'error');
    }
});
</script>
{% endblock %}
